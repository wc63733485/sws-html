<!DOCTYPE html>
<html xmlns:hidden="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../static/libs/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../static/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="../static/css/font-awesome.min.css" media="all">
    <style type="text/css">
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .layui-table[lay-skin="row"] tr th {
            border-width: 1px 1px 1px 1px;
            border-top-width: 1px;
            border-left-width: 1px;
        }

        .layui-table-body {
            overflow-y: auto;
            overflow-x: hidden;
        }
    </style>

    <script src="../static/libs/jquery.min.js"></script>
    <script src="../static/libs/echarts.min.js"></script>
    <script src="../static/libs/sws-common.js"></script>
    <!--    <script src="../static/libs/realChart.js"></script>-->
    <script src="../static/libs/layui/layui.js"></script>
</head>

<body>
<div class="layui-fluid" style="float: left;width: 15%;height: 96%;padding-right: 5px;">
    <div class="layui-card" style="height: 100%">
        <div class="layui-inline" style="width: 100%;">
            <div class="layui-input-block" style="margin-left:10px;margin-top:10px;margin-right: 10px">

                <input type="text" name="search" id="search" placeholder="请输入名称" autocomplete="off" class="layui-input"
                       style="margin-left: 0px;width: 60%;float: left">

                <button type="button" class="layui-btn layui-btn-sm layuiadmin-btn-admin"
                        style="margin-left:15px;margin-top:5px;float: left;background-color: #6bd9c2"
                        lay-menutree="search">
                    <i class="layui-icon layui-icon-search layuiadmin-button-btn" style="font-size: 20px;"></i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm layuiadmin-btn-admin"
                        style="margin-left:5px;margin-top:5px;float: right;background-color: #23c6c8"
                        lay-menutree="reload">
                    <i class="layui-icon layui-icon-spread-left layuiadmin-button-btn" style="font-size: 20px;"></i>
                </button>
            </div>
            <hr>
        </div>

        <div id="assMenu" class="demo-tree"></div>
    </div>
</div>
<div class="layui-fluid" style="float: right;width: 82%;height: 96%;padding-left: 5px;">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style="text-align: left;width: 70px;">开始时间</label>
                    <div class="layui-input-block" style="margin-left:100px">
                        <input type="text" name="username" placeholder="请输入" id="starTime" class="layui-input"
                               placeholder="yyyy-MM-dd HH:mm:ss">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="text-align: left;width: 70px">结束时间</label>
                    <div class="layui-input-block" style="margin-left:100px">
                        <input type="text" name="username" placeholder="请输入" id="endTime" class="layui-input"
                               placeholder="yyyy-MM-dd HH:mm:ss">
                    </div>
                </div>
                <!--                <div class="layui-inline">-->
                <!--                    <label class="layui-form-label" style="text-align: left;width: 50px">&nbsp;&nbsp;项&nbsp;&nbsp;&nbsp;目</label>-->
                <!--                    <div class="layui-input-block" style="margin-left:80px">-->
                <!--                        <input type="text" name="projectId" placeholder="请输入" autocomplete="off" class="layui-input">-->
                <!--                    </div>-->
                <!--                </div>-->
                <div class="layui-inline">
                    <button class="layui-btn layui-btn-sm layui-btn-radius layuiadmin-btn-admin"
                            style="background-color: #1ab394" lay-submit lay-filter="LAY-user-back-search">
                        <span style="text-align:center;display:block;"><i
                                class="layui-icon layui-icon-search layuiadmin-button-btn"
                                style="font-size: 14px;"> 查 询</i></span>
                    </button>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layui-btn-sm layui-btn-radius layuiadmin-btn-admin"
                            style="background-color: #f8ac59" data-type="reload"
                            style="background-color: orangered;">
                        <span style="text-align:center;display:block;"><i
                                class="layui-icon layui-icon-refresh layuiadmin-button-btn" style="font-size: 14px;"> 重 置</i></span>
                    </button>
                </div>
            </div>
        </div>

        <!--        <div class="layui-card-body" >-->
        <!--            <table class="layui-hide" id="user_table" lay-filter="user_table"></table>-->
        <!--        </div>-->

    </div>
    <div class="layui-tab layui-tab-card" lay-filter="real-tab" style="height: 80%;">
        <ul class="layui-tab-title">
            <li class="layui-this" lay-id="real-data" style="width: 22%">实时数据</li>
            <li lay-id="real-alarm" style="width: 23%">报警记录</li>
            <li lay-id="send-param" style="width: 23%">远程下参</li>
            <li lay-id="real-analysis" style="width: 23.9%">实时分析</li>
        </ul>
        <div class="layui-tab-content" style="height: 100%;background-color: white">
            <div class="layui-tab-item layui-show" style="height: 100%">
                <div class="layui-card-body" id="tt" style="width: 50%;height: 95%;padding: 0px 15px;float: left;">

                    <table class="layui-table" id="demo1">

                    </table>
                </div>
                <!--    实时曲线   -->
                <div class="layui-card-body" id="chart-1"
                     style="width: 45%;height: 50%;padding: 0px 15px;float: right;">


                </div>
            </div>
            <div class="layui-tab-item">2</div>
            <div class="layui-tab-item">3</div>
            <div class="layui-tab-item">4</div>
        </div>
    </div>
</div>

<script src="../static/libs/mqtt.js" type="text/javascript"></script>
<script src="../static/libs/sws-mqtt.js"></script>

<script>

    $(function () {

        var mqttMessage = {}
        var iotCode = "";
        Client = new Paho.MQTT.Client('39.107.221.228', 8083, "USER" + new Date().getTime());
        //建立客户端实例
        var options = {
            timeout: 5,
            keepAliveInterval: 60,
            cleanSession: true,
            useSSL: false,
            userName: user.loginName,
            password: user.password,
            onSuccess: function (e) {
                console.log("success");
            },
            onFailure: function (e) {

            }
        };


        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                console.log("连接已断开");
            }
        }

        function onMessageArrived(message) {

            realChartInit(message.payloadString)//渲染图表
        }

        Client.connect(options);

        Client.onConnectionLost = onConnectionLost;
        Client.onMessageArrived = onMessageArrived;


        function realChartInit(message) {
            mqttMessage = JSON.parse(message);
            for (var i = 0; i < mqttMessage.Data.length; i++) {
                console.info(mqttMessage.Data[i].name+"-"+mqttMessage.Data[i].value)
                $("#value-" + mqttMessage.Data[i].name).text(mqttMessage.Data[i].value)
                $("#time-" + mqttMessage.Data[i].name).text(mqttMessage.time)
            }
        }

        assignmentsMenu();

        function assignmentsMenu() {
            layui.use(['table', 'tree', 'util', 'element', 'laydate'], function () {
                var $ = layui.$
                    , tree = layui.tree
                    , table = layui.table
                    , util = layui.util
                    , element = layui.element
                    , laydate = layui.laydate;

                //查询 开始时间
                laydate.render({
                    elem: '#starTime'
                    , type: 'datetime'
                    , max: format(new Date().getTime())
                    , theme: 'grid'
                });

                //查询 结束时间
                laydate.render({
                    elem: '#endTime'
                    , type: 'datetime'
                    , max: format(new Date().getTime())
                    , theme: 'grid'
                });

                $('.site-demo-active').on('click', function () {
                    var othis = $(this), type = othis.data('type');
                    active[type] ? active[type].call(this, othis) : '';
                });


                function realDataInit(deviceId) {
                    var title1 = ""
                    var title2 = ""
                    var deviceTypeId = "";
                    $.ajax({
                        type: "GET",
                        url: deviceUrl + "/dl/qbd/" + deviceId,
                        async: false,
                        headers: {
                            'token': sessionStorage.getItem("token"),
                        },
                        success: function (r) {
                            deviceTypeId = r.data.deviceTypeId
                            console.info(iotCode)
                            if (!iotCode == "") {
                                Client.unsubscribe('Topic/flexem/fbox/' + iotCode + '/system/MonitorData');
                            }
                            iotCode = r.data.iotcode
                            Client.subscribe('Topic/flexem/fbox/' + iotCode + '/system/MonitorData');
                        },
                        error: function (e, t) {
                            if (e.status == 401) {
                                layer.msg("请刷新或重新登录", {icon: 0})
                                return;
                            }
                            i.errorView("接口请求开了小差..." + t), i.renderForm(), i.setColsWidth()
                        }
                    })

                    $.ajax({
                        type: "GET",
                        url: deviceTypeUrl + "/dt/qbdd/" + deviceTypeId,
                        async: false,
                        headers: {
                            'token': sessionStorage.getItem("token"),
                        },
                        success: function (r) {
                            title1 = r.data.name
                            $.ajax({
                                type: "GET",
                                url: deviceTypeUrl + "/dt/qbdpd/" + r.data.parentId,
                                async: false,
                                headers: {
                                    'token': sessionStorage.getItem("token"),
                                },
                                success: function (r) {
                                    title2 = "(" + r.data.name + ")"
                                },
                                error: function (e, t) {
                                    if (e.status == 401) {
                                        layer.msg("请刷新或重新登录", {icon: 0})
                                        return;
                                    }
                                }
                            })
                        },
                        error: function (e, t) {
                            if (e.status == 401) {
                                layer.msg("请刷新或重新登录", {icon: 0})
                                return;
                            }
                        }
                    })
                    //展示已知数据
                    table.render({
                        elem: '#demo1'
                        , url: deviceUnitUrl + "/du/qbdtd/" + deviceTypeId
                        , height: $("#tt").height()
                        , headers: {
                            'token': sessionStorage.getItem("token"),
                        }
                        , cols: [[{title: title1 + title2+" IOT编号:"+iotCode, align: "center", colspan: "7"}], [ //标题栏
                            {field: 'sortId', title: '排序', align: "center", width: 80, sort: true}
                            , {field: 'name', align: "center", title: '参数', width: 130}
                            , {field: 'referenceRange', align: "center", title: '参考值范围', minWidth: 120}
                            , {
                                field: 'value', align: "center", title: '数值', width: 60
                                , templet: function (res) {
                                    return '<span id="value-' + res.dataName + '"></span>';
                                }
                            }
                            , {field: 'unit', align: "center", title: '单位', minWidth: 50}
                            , {
                                field: 'time', align: "center", title: '上报时间', width: 150, templet: function (res) {
                                    return '<span id="time-' + res.dataName + '"></span>';
                                }
                            }
                            , {field: 'remark', align: "center", title: '备注', width: 100}
                        ]]
                        , skin: 'row' //表格风格
                        , response: {
                            statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
                        }
                        // ,even: true
                        , size: "sm"
                        // , page: true //是否显示分页
                        // ,limits: [5]
                        // ,limit: 5 //每页默认显示的数量
                    });
                }

                //基本演示
                tree.render({
                    elem: '#assMenu'
                    , data: projectArrayToJson("")
                    , id: 'assMenu'
                    , isJump: false //是否允许点击节点时弹出新窗口跳转
                    , click: function (obj) {
                        var data = obj.data;  //获取当前点击的节点数据
                        if (data.isDevice != undefined && data.isDevice == true) {
                            realDataInit(data.id);
                            element.tabChange('real-tab', 'real-data'); //切换到：实时数据
                        }
                    }
                });

                //按钮事件
                util.event('lay-menutree', {
                    search: function (othis) {
                        var search = $("#search").val()
                        layer.load(2);
                        tree.render({
                            elem: '#assMenu'
                            , data: projectArrayToJson(search)
                            , id: 'assMenu'
                            , isJump: false //是否允许点击节点时弹出新窗口跳转
                            , click: function (obj) {
                                var data = obj.data;  //获取当前点击的节点数据
                                if (data.isDevice != undefined && data.isDevice == true) {
                                    realDataInit(data.id);
                                    element.tabChange('real-tab', 'real-data'); //切换到：用户管理
                                }
                            }
                        });
                        layer.closeAll('loading');
                    },
                    reload: function () {
                        layer.load(2);
                        $("#search").val("");
                        tree.render({
                            elem: '#assMenu'
                            , data: projectArrayToJson("")
                            , id: 'assMenu'
                            , isJump: false //是否允许点击节点时弹出新窗口跳转
                            , click: function (obj) {
                                var data = obj.data;  //获取当前点击的节点数据
                                if (data.isDevice != undefined && data.isDevice == true) {
                                    realDataInit(data.id);
                                    element.tabChange('real-tab', 'real-data'); //切换到：用户管理
                                }
                            }
                        });
                        layer.closeAll('loading');
                    }
                });
            });
        }

        function projectArrayToJson(search) {
            var res = [];
            $.ajax({
                type: "GET",
                url: sysUrl + "/pct/gpt",
                async: false,
                headers: {
                    'token': sessionStorage.getItem("token"),
                },
                success: function (r) {
                    var children = [];
                    for (var i = 0; i < r.data.length; i++) {
                        var project = new Object();
                        project.title = r.data[i].projectName;
                        project.id = r.data[i].projectId;
                        project.icon = "fa fa-bar-chart-o";
                        project.spread = true;
                        children = pumpHouseArrayToJson(r.data[i].projectId, search)
                        if (children.length != 0) {
                            project.children = children
                        }
                        if (search != "" && r.data[i].projectName.indexOf(search) != -1) {
                            project.textcolor = "red";
                        }
                        res.push(project)
                    }
                },
                error: function (e, t) {
                    if (e.status == 401) {
                        layer.msg("请刷新或重新登录", {icon: 0})
                        return;
                    }
                    i.errorView("接口请求开了小差..." + t), i.renderForm(), i.setColsWidth()
                }
            })
            return res
        }

        function pumpHouseArrayToJson(projectId, search) {
            var res = [];
            $.ajax({
                type: "GET",
                url: pumpHouseUrl + "/pmp/qpbp/" + projectId,
                async: false,
                headers: {
                    'token': sessionStorage.getItem("token"),
                },
                success: function (r) {
                    var children = [];
                    for (var i = 0; i < r.data.length; i++) {
                        var pumphouse = new Object();
                        pumphouse.title = r.data[i].pumphouseName;
                        pumphouse.id = r.data[i].pumphouseId;
                        pumphouse.icon = "fa fa-home fa-lg";
                        pumphouse.spread = true;
                        children = deviceArrayToJson(r.data[i].pumphouseId, search)
                        if (children.length != 0) {
                            pumphouse.children = children
                        }
                        if (search != "" && r.data[i].pumphouseName.indexOf(search) != -1) {
                            pumphouse.textcolor = "red";
                        }
                        res.push(pumphouse)
                    }
                },
                error: function (e, t) {
                    if (e.status == 401) {
                        layer.msg("请刷新或重新登录", {icon: 0})
                        return;
                    }
                    i.errorView("接口请求开了小差..." + t), i.renderForm(), i.setColsWidth()
                }
            });
            return res;
        }

        function deviceArrayToJson(pumphouseId, search) {
            var res = [];
            $.ajax({
                type: "GET",
                url: deviceUrl + "/dce/qdbd/" + pumphouseId,
                async: false,
                headers: {
                    'token': sessionStorage.getItem("token"),
                },
                success: function (r) {
                    for (var i = 0; i < r.data.length; i++) {
                        var device = new Object();
                        device.title = r.data[i].name;
                        device.id = r.data[i].deviceId;
                        device.bgcolor = "green";
                        device.icon = "fa fa-signal";
                        device.spread = true;
                        device.isDevice = true;
                        if (search != "" && r.data[i].name.indexOf(search) != -1) {
                            device.textcolor = "red";
                        }
                        res.push(device)
                    }
                },
                error: function (e, t) {
                    if (e.status == 401) {
                        layer.msg("请刷新或重新登录", {icon: 0})
                        return;
                    }
                    i.errorView("接口请求开了小差..." + t), i.renderForm(), i.setColsWidth()
                }
            });
            return res;
        }
    });

    var realChart = echarts.init(document.getElementById('chart-1'));

    // $.ajax({
    //     url: deviceDataUrl + "/getDeviceDataByDataName?deviceId=" + parm1 + "&dataName=" + parm4 + "&beginTime=" + startTime,
    //     type: "GET",
    //     dataType: 'json',
    //     success: function (r) {
    //         if (r.time.length > 0) {
    //             beginTime = r.time[r.time.length - 1];
    //             for (var a = 0; a < r.time.length; a++) {
    //                 var timer = formatNoYear(r.time[a]);
    //                 timeData.shift();
    //                 timeData.push(timer);
    //                 newData.shift();
    //                 newData.push(r.new[a]);
    //             }
    //         }
    //     }
    // })

    realChart.setOption({
        title: {
            text: "parm2" + '实时曲线',
            subtext: "周期 20s",
            textStyle: {
                fontSize: 14,
                fontWeight: 'lighter',
            },
            subtextStyle: {
                fontSize: 10,
                fontWeight: "normal",
                color: "blcak",
            }
        },
        legend: {
            data: ["实时" + "parm2"],
        },
        grid: {
            left: '4%',
            right: '4%',
            bottom: '6%',
            containLabel: true,
            transitionDuration: 0,
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                animation: false
            }

        },

        toolbox: {
            show: true,
            feature: {
                magicType: {type: ['line', 'bar']},
                restore: {},
                saveAsImage: {}
            }
        },
        xAxis: {
            type: 'category',
            data: "timeData",
            nameTextStyle: {color: '#5b6be8'},
            boundaryGap: false,
            minorTick: {
                show: true,
                splitNumber: 10,
            },
            axisLine: {
                lineStyle: {
                    color: '#009688',
                    width: 2
                },
            },
            axisLabel: {
                textStyle: {
                    color: '#009688'
                }
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#eaeaea'
                }
            },
            minorSplitLine: {
                show: true,
                lineStyle: {
                    color: '#ddd'
                }
            }

        },
        yAxis: {
            type: 'value',
            scale: true,
            showSymbol: true,
            nameTextStyle: {color: '#5b6be8'},
            axisLabel: {
                formatter: '{value}' + "parm3",
                textStyle: {
                    color: '#009688'
                }

            },
            axisLine: {
                lineStyle: {
                    color: '#009688',
                    width: 2
                },
            },
            splitNumber: 4,
            axisPointer: {
                snap: true
            },
            minorTick: {
                show: true,
                splitNumber: 10,
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#eaeaea'
                }
            },
            minorSplitLine: {
                show: true,
                lineStyle: {
                    color: '#ddd'
                }
            }
        },
        series: [{
            name: "实时" + "parm2",
            smooth: true,
            type: 'line',
            itemStyle: {
                color: '#1e9fff',
            },
            markPoint: {
                itemStyle: {
                    color: '#1e9fff',
                },
                data: [
                    {type: 'max', name: '最大值'},
                    {type: 'min', name: '最小值'}
                ]
            },
            lineStyle: {
                color: '#1e9fff',
            },
            showSymbol: true,
            // hoverAnimation: false,
            data: "newData",
            markLine: {
                lineStyle: {
                    color: '#1e9fff',
                    width: 1
                },
                data: [
                    {type: 'average', name: '平均值1'}
                ]
            }
        }]
    });
</script>
</body>
</html>